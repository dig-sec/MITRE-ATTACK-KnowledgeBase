# Alerting & Detection Strategy (ADS) Report: SIP and Trust Provider Hijacking on Windows

## Goal
The aim of this technique is to detect adversarial attempts to bypass security monitoring through the hijacking of Security Support Provider Interface (SSPI), specifically by exploiting the `regsvr32` utility to load malicious DLLs. This allows attackers to capture sensitive information such as credentials and manipulate trust relationships within a network.

## Categorization
- **MITRE ATT&CK Mapping:** T1553.003 - SIP and Trust Provider Hijacking
- **Tactic / Kill Chain Phases:** Defense Evasion
- **Platforms:** Windows

[MITRE ATT&CK Reference](https://attack.mitre.org/techniques/T1553/003)

## Strategy Abstract
The detection strategy leverages a combination of log analysis, process monitoring, and heuristic evaluation to identify unusual or unauthorized use of the `regsvr32` utility on Windows systems. Key data sources include:
- Security Event Logs: To capture suspicious event IDs related to DLL registrations.
- Process Monitoring Tools: To observe processes that spawn `regsvr32`.
- File Integrity Monitoring: To detect changes in common system directories where malicious DLLs might be registered.

Patterns analyzed involve unusual execution contexts for `regsvr32`, such as from non-standard locations or executed by unprivileged users. Additionally, anomalies in the process tree and unexpected DLL registrations are scrutinized to identify potential hijacking attempts.

## Technical Context
Adversaries exploit SSPI hijacking by inserting malicious DLLs into trusted directories (e.g., `System32`), which are then registered using `regsvr32`. This allows attackers to intercept network credentials or manipulate authentication processes. Real-world execution involves:
- Creating a malicious DLL that mimics a legitimate security provider.
- Registering this DLL using `regsvr32`.
- Leveraging elevated trust to capture sensitive data or alter system behavior.

Adversary emulation can involve deploying a benign version of such a DLL and registering it via `regsvr32` from various locations on the filesystem to observe detection responses.

## Blind Spots and Assumptions
- **Limitations:** The strategy may not detect stealthy, sophisticated attacks that use advanced obfuscation techniques or execute directly within trusted processes.
- **Assumptions:** It assumes that all instances of `regsvr32` usage from non-standard directories are potentially malicious. This could overlook legitimate administrative tasks in certain environments.

## False Positives
Potential false positives include:
- Legitimate deployment scripts using `regsvr32` for software installations or updates.
- Administrators registering custom DLLs for legitimate purposes.
- Third-party applications that require specific configurations involving `regsvr32`.

## Priority
**Priority Level: High**

Justification: Given the potential impact of SSPI hijacking on sensitive data integrity and network trust relationships, this technique is considered high priority. The ability to capture credentials or manipulate authentication processes poses a significant risk if undetected.

## Validation (Adversary Emulation)
To emulate SIP Hijacking via Custom DLL using `regsvr32` in a test environment:

1. **Create a Test Environment:**
   - Set up a controlled Windows environment with monitoring tools enabled.

2. **Develop a Sample Malicious DLL:**
   - Write or obtain a benign DLL that logs actions similar to what an attacker's version might do (e.g., logging registry changes).

3. **Register the DLL:**
   - Use `regsvr32` to register the custom DLL from various directories, including non-standard locations such as user-specific folders.
   ```shell
   regsvr32 C:\Users\testuser\Desktop\custom.dll
   ```

4. **Monitor Responses:**
   - Observe logs and alerts generated by security tools to validate detection.

5. **Analyze Detection Efficacy:**
   - Ensure that the monitoring setup captures all relevant events and differentiates between malicious and benign activities.

## Response
When an alert is triggered:
1. **Immediate Isolation:** Quarantine the affected system to prevent lateral movement.
2. **Forensic Analysis:** Collect and analyze logs, process trees, and registry changes for indicators of compromise (IOCs).
3. **Review Permissions:** Check user permissions related to `regsvr32` execution contexts.
4. **Communication:** Inform relevant stakeholders about potential security incidents.

## Additional Resources
- [Scripting/CommandLine Process Spawned Regsvr32](https://docs.microsoft.com/en-us/windows/win32/shell/regsvr32)
- [Regsvr32 Execution From Highly Suspicious Location](https://www.crowdstrike.com/blog/hunting-for-llms-regsvr32-execution-using-sysmon/)

This report provides a comprehensive ADS framework for detecting and responding to SIP and Trust Provider Hijacking on Windows systems.