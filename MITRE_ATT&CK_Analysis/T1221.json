{
    "id": "T1221",
    "name": "Template Injection",
    "description": "Adversaries may create or modify references in Office document templates to conceal malicious code or force authentication attempts. Microsoft’s Office Open XML (OOXML) specification defines an XML-based format for Office documents (.docx, xlsx, .pptx) to replace older binary formats (.doc, .xls, .ppt). OOXML files are packed together ZIP archives compromised of various XML files, referred to as parts, containing properties that collectively define how a document is rendered. (Citation: Microsoft Open XML July 2017)\nProperties within parts may reference shared public resources accessed via online URLs. For example, template properties reference a file, serving as a pre-formatted document blueprint, that is fetched when the document is loaded.\nAdversaries may abuse this technology to initially conceal malicious code to be executed via documents. Template references injected into a document may enable malicious payloads to be fetched and executed when the document is loaded. (Citation: SANS Brian Wiltse Template Injection) These documents can be delivered via other techniques such as [Phishing](T1566) and/or [Taint Shared Content](T1080) and may evade static detections since no typical indicators (VBA macro, script, etc.) are present until after the malicious payload is fetched. (Citation: Redxorblue Remote Template Injection) Examples have been seen in the wild where template injection was used to load malicious code containing an exploit. (Citation: MalwareBytes Template Injection OCT 2017)\nThis technique may also enable [Forced Authentication](T1187) by injecting a SMB/HTTPS (or other credential prompting) URL and triggering an authentication attempt. (Citation: Anomali Template Injection MAR 2018) (Citation: Talos Template Injection July 2017) (Citation: ryhanson phishery SEPT 2016)",
    "platforms": "Windows",
    "kill_chain_phases": "Defense Evasion",
    "data_sources": "Process: Process Creation, Network Traffic: Network Connection Creation, Network Traffic: Network Traffic Content",
    "detection": "Analyze process behavior to determine if an Office application is performing actions, such as opening network connections, reading files, spawning abnormal child processes (ex: [PowerShell](T1059.001)), or other suspicious actions that could relate to post-compromise behavior.",
    "url": "https://attack.mitre.org/techniques/T1221",
    "enrichments": {
        "attack_rule_map": [],
        "cycat": {
            "cycat": {
                "cycat_related_uuids": [
                    "7f79ab3b-6744-4857-85a0-ec2803a67372",
                    "2d9403d5-7927-46b7-8216-37ab7c9ec5e3",
                    "dc31fe1e-d722-49da-8f5f-92c7b5aff534",
                    "c7e49501-6021-414f-bfa1-94519d8ec314"
                ],
                "lookup_results": [
                    {
                        "uuid": "7f79ab3b-6744-4857-85a0-ec2803a67372",
                        "lookup_data": {
                            "description": "Scraper: Rising Tide: Chasing the Currents of Espionage in the South China Sea",
                            "link": "http://www.botvrij.eu/data/feed-osint/7f79ab3b-6744-4857-85a0-ec2803a67372.json",
                            "misp:feed": "http://www.botvrij.eu/data/feed-osint",
                            "timestamp": "1663768749",
                            "uuid": "7f79ab3b-6744-4857-85a0-ec2803a67372",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "2d9403d5-7927-46b7-8216-37ab7c9ec5e3",
                        "lookup_data": {
                            "description": "Detects set value ms-msdt MSProtocol URI scheme in Registry that could be an attempt to exploit CVE-2022-30190.",
                            "raw": "author: Sittikorn S\ndate: 2020/05/31\ndescription: Detects set value ms-msdt MSProtocol URI scheme in Registry that could\n  be an attempt to exploit CVE-2022-30190.\ndetection:\n  condition: selection\n  selection:\n    EventType: SetValue\n    TargetObject|startswith: HKCR\\ms-msdt\\\nfalsepositives:\n- Unknown\nid: 2d9403d5-7927-46b7-8216-37ab7c9ec5e3\nlevel: medium\nlogsource:\n  category: registry_set\n  product: windows\nmodified: 2022/10/09\nreferences:\n- https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-30190\n- https://msrc-blog.microsoft.com/2022/05/30/guidance-for-cve-2022-30190-microsoft-support-diagnostic-tool-vulnerability/\nstatus: test\ntags:\n- attack.defense_evasion\n- attack.t1221\ntitle: Suspicious Set Value of MSDT in Registry (CVE-2022-30190)\n",
                            "sigma:id": "2d9403d5-7927-46b7-8216-37ab7c9ec5e3",
                            "title": "Suspicious Set Value of MSDT in Registry (CVE-2022-30190)",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "dc31fe1e-d722-49da-8f5f-92c7b5aff534",
                        "lookup_data": {
                            "mitre-attack-id": "T1221",
                            "mitre-cti:description": "Adversaries may create or modify references in user document templates to conceal malicious code or force authentication attempts. For example, Microsoft’s Office Open XML (OOXML) specification defines an XML-based format for Office documents (.docx, xlsx, .pptx) to replace older binary formats (.doc, .xls, .ppt). OOXML files are packed together ZIP archives compromised of various XML files, referred to as parts, containing properties that collectively define how a document is rendered.(Citation: Microsoft Open XML July 2017)\n\nProperties within parts may reference shared public resources accessed via online URLs. For example, template properties may reference a file, serving as a pre-formatted document blueprint, that is fetched when the document is loaded.\n\nAdversaries may abuse these templates to initially conceal malicious code to be executed via user documents. Template references injected into a document may enable malicious payloads to be fetched and executed when the document is loaded.(Citation: SANS Brian Wiltse Template Injection) These documents can be delivered via other techniques such as [Phishing](https://attack.mitre.org/techniques/T1566) and/or [Taint Shared Content](https://attack.mitre.org/techniques/T1080) and may evade static detections since no typical indicators (VBA macro, script, etc.) are present until after the malicious payload is fetched.(Citation: Redxorblue Remote Template Injection) Examples have been seen in the wild where template injection was used to load malicious code containing an exploit.(Citation: MalwareBytes Template Injection OCT 2017)\n\nAdversaries may also modify the <code>*\\template</code> control word within an .rtf file to similarly conceal then download malicious code. This legitimate control word value is intended to be a file destination of a template file resource that is retrieved and loaded when an .rtf file is opened. However, adversaries may alter the bytes of an existing .rtf file to insert a template control word field to include a URL resource of a malicious payload.(Citation: Proofpoint RTF Injection)(Citation: Ciberseguridad Decoding malicious RTF files)\n\nThis technique may also enable [Forced Authentication](https://attack.mitre.org/techniques/T1187) by injecting a SMB/HTTPS (or other credential prompting) URL and triggering an authentication attempt.(Citation: Anomali Template Injection MAR 2018)(Citation: Talos Template Injection July 2017)(Citation: ryhanson phishery SEPT 2016)",
                            "mitre-cti:name": "Template Injection",
                            "mitre-cti:type": "attack-pattern",
                            "raw": "{'x_mitre_platforms': ['Windows'], 'x_mitre_domains': ['enterprise-attack'], 'x_mitre_contributors': ['Michael Raggi @aRtAGGI', 'Brian Wiltse @evalstrings', 'Patrick Campbell, @pjcampbe11'], 'object_marking_refs': ['marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168'], 'id': 'attack-pattern--dc31fe1e-d722-49da-8f5f-92c7b5aff534', 'type': 'attack-pattern', 'created': '2018-10-17T00:14:20.652Z', 'created_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5', 'external_references': [{'source_name': 'mitre-attack', 'external_id': 'T1221', 'url': 'https://attack.mitre.org/techniques/T1221'}, {'url': 'https://docs.microsoft.com/previous-versions/office/developer/office-2007/aa338205(v=office.12)', 'description': 'Microsoft. (2014, July 9). Introducing the Office (2007) Open XML File Formats. Retrieved July 20, 2018.', 'source_name': 'Microsoft Open XML July 2017'}, {'source_name': 'SANS Brian Wiltse Template Injection', 'url': 'https://www.sans.org/reading-room/whitepapers/testing/template-injection-attacks-bypassing-security-controls-living-land-38780', 'description': 'Wiltse, B.. (2018, November 7). Template Injection Attacks - Bypassing Security Controls by Living off the Land. Retrieved April 10, 2019.'}, {'url': 'http://blog.redxorblue.com/2018/07/executing-macros-from-docx-with-remote.html', 'description': 'Hawkins, J. (2018, July 18). Executing Macros From a DOCX With Remote Template Injection. Retrieved October 12, 2018.', 'source_name': 'Redxorblue Remote Template Injection'}, {'url': 'https://blog.malwarebytes.com/threat-analysis/2017/10/decoy-microsoft-word-document-delivers-malware-through-rat/', 'description': 'Segura, J. (2017, October 13). Decoy Microsoft Word document delivers malware through a RAT. Retrieved July 21, 2018.', 'source_name': 'MalwareBytes Template Injection OCT 2017'}, {'source_name': 'Proofpoint RTF Injection', 'url': 'https://www.proofpoint.com/us/blog/threat-insight/injection-new-black-novel-rtf-template-inject-technique-poised-widespread', 'description': 'Raggi, M. (2021, December 1). Injection is the New Black: Novel RTF Template Inject Technique Poised for Widespread Adoption\\u202fBeyond APT Actors\\u202f. Retrieved December 9, 2021.'}, {'source_name': 'Ciberseguridad Decoding malicious RTF files', 'url': 'https://ciberseguridad.blog/decodificando-ficheros-rtf-maliciosos/', 'description': 'Pedrero, R.. (2021, July). Decoding malicious RTF files. Retrieved November 16, 2021.'}, {'url': 'https://forum.anomali.com/t/credential-harvesting-and-malicious-file-delivery-using-microsoft-office-template-injection/2104', 'description': 'Intel_Acquisition_Team. (2018, March 1). Credential Harvesting and Malicious File Delivery using Microsoft Office Template Injection. Retrieved July 20, 2018.', 'source_name': 'Anomali Template Injection MAR 2018'}, {'url': 'https://blog.talosintelligence.com/2017/07/template-injection.html', 'description': 'Baird, S. et al.. (2017, July 7). Attack on Critical Infrastructure Leverages Template Injection. Retrieved July 21, 2018.', 'source_name': 'Talos Template Injection July 2017'}, {'url': 'https://github.com/ryhanson/phishery', 'description': 'Hanson, R. (2016, September 24). phishery. Retrieved July 21, 2018.', 'source_name': 'ryhanson phishery SEPT 2016'}], 'modified': '2022-01-12T18:16:56.176Z', 'name': 'Template Injection', 'description': 'Adversaries may create or modify references in user document templates to conceal malicious code or force authentication attempts. For example, Microsoft’s Office Open XML (OOXML) specification defines an XML-based format for Office documents (.docx, xlsx, .pptx) to replace older binary formats (.doc, .xls, .ppt). OOXML files are packed together ZIP archives compromised of various XML files, referred to as parts, containing properties that collectively define how a document is rendered.(Citation: Microsoft Open XML July 2017)\\n\\nProperties within parts may reference shared public resources accessed via online URLs. For example, template properties may reference a file, serving as a pre-formatted document blueprint, that is fetched when the document is loaded.\\n\\nAdversaries may abuse these templates to initially conceal malicious code to be executed via user documents. Template references injected into a document may enable malicious payloads to be fetched and executed when the document is loaded.(Citation: SANS Brian Wiltse Template Injection) These documents can be delivered via other techniques such as [Phishing](https://attack.mitre.org/techniques/T1566) and/or [Taint Shared Content](https://attack.mitre.org/techniques/T1080) and may evade static detections since no typical indicators (VBA macro, script, etc.) are present until after the malicious payload is fetched.(Citation: Redxorblue Remote Template Injection) Examples have been seen in the wild where template injection was used to load malicious code containing an exploit.(Citation: MalwareBytes Template Injection OCT 2017)\\n\\nAdversaries may also modify the <code>*\\\\template</code> control word within an .rtf file to similarly conceal then download malicious code. This legitimate control word value is intended to be a file destination of a template file resource that is retrieved and loaded when an .rtf file is opened. However, adversaries may alter the bytes of an existing .rtf file to insert a template control word field to include a URL resource of a malicious payload.(Citation: Proofpoint RTF Injection)(Citation: Ciberseguridad Decoding malicious RTF files)\\n\\nThis technique may also enable [Forced Authentication](https://attack.mitre.org/techniques/T1187) by injecting a SMB/HTTPS (or other credential prompting) URL and triggering an authentication attempt.(Citation: Anomali Template Injection MAR 2018)(Citation: Talos Template Injection July 2017)(Citation: ryhanson phishery SEPT 2016)', 'kill_chain_phases': [{'kill_chain_name': 'mitre-attack', 'phase_name': 'defense-evasion'}], 'x_mitre_detection': 'Analyze process behavior to determine if user document applications (such as Office) are performing actions, such as opening network connections, reading files, spawning abnormal child processes (ex: [PowerShell](https://attack.mitre.org/techniques/T1059/001)), or other suspicious actions that could relate to post-compromise behavior.\\n\\nMonitor .rtf files for strings indicating the <code>&#42;\\\\template</code> control word has been modified to retrieve a URL resource, such as <code>&#42;\\\\template http</code> or <code>&#42;\\\\template \\\\u-</code>.', 'x_mitre_version': '1.3', 'x_mitre_modified_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5', 'x_mitre_data_sources': ['Process: Process Creation', 'Network Traffic: Network Traffic Content', 'Network Traffic: Network Connection Creation'], 'x_mitre_defense_bypassed': ['Static File Analysis'], 'x_mitre_permissions_required': ['User'], 'x_mitre_is_subtechnique': False}",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "c7e49501-6021-414f-bfa1-94519d8ec314",
                        "lookup_data": {
                            "mitre-attack-id": "T1221",
                            "mitre-cti:description": "Consider disabling Microsoft Office macros/active content to prevent the execution of malicious payloads in documents (Citation: Microsoft Disable Macros), though this setting may not mitigate the [Forced Authentication](https://attack.mitre.org/techniques/T1187) use for this technique.\n\nBecause this technique involves user interaction on the endpoint, it's difficult to fully mitigate. However, there are potential mitigations including training users to identify social engineering techniques and spearphishing emails. Network/Host intrusion prevention systems, antivirus, and detonation chambers can be employed to prevent documents from fetching and/or executing malicious payloads. (Citation: Anomali Template Injection MAR 2018)",
                            "mitre-cti:name": "Template Injection Mitigation",
                            "mitre-cti:type": "course-of-action",
                            "raw": "{'x_mitre_domains': ['enterprise-attack'], 'object_marking_refs': ['marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168'], 'id': 'course-of-action--c7e49501-6021-414f-bfa1-94519d8ec314', 'type': 'course-of-action', 'created': '2018-10-17T00:14:20.652Z', 'created_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5', 'external_references': [{'source_name': 'mitre-attack', 'url': 'https://attack.mitre.org/mitigations/T1221', 'external_id': 'T1221'}, {'url': 'https://support.office.com/article/enable-or-disable-macros-in-office-files-12b036fd-d140-4e74-b45e-16fed1a7e5c6', 'description': 'Microsoft. (n.d.). Enable or disable macros in Office files. Retrieved September 13, 2018.', 'source_name': 'Microsoft Disable Macros'}, {'source_name': 'Anomali Template Injection MAR 2018', 'description': 'Intel_Acquisition_Team. (2018, March 1). Credential Harvesting and Malicious File Delivery using Microsoft Office Template Injection. Retrieved July 20, 2018.', 'url': 'https://forum.anomali.com/t/credential-harvesting-and-malicious-file-delivery-using-microsoft-office-template-injection/2104'}], 'modified': '2019-07-25T12:27:19.577Z', 'name': 'Template Injection Mitigation', 'description': \"Consider disabling Microsoft Office macros/active content to prevent the execution of malicious payloads in documents (Citation: Microsoft Disable Macros), though this setting may not mitigate the [Forced Authentication](https://attack.mitre.org/techniques/T1187) use for this technique.\\n\\nBecause this technique involves user interaction on the endpoint, it's difficult to fully mitigate. However, there are potential mitigations including training users to identify social engineering techniques and spearphishing emails. Network/Host intrusion prevention systems, antivirus, and detonation chambers can be employed to prevent documents from fetching and/or executing malicious payloads. (Citation: Anomali Template Injection MAR 2018)\", 'x_mitre_deprecated': True, 'x_mitre_version': '1.0', 'x_mitre_modified_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5'}",
                            "_cycat_type": "Item"
                        }
                    }
                ]
            }
        },
        "atomics": [
            {
                "attack_technique": "T1221",
                "display_name": "Template Injection",
                "atomic_tests": [
                    {
                        "name": "WINWORD Remote Template Injection",
                        "auto_generated_guid": "1489e08a-82c7-44ee-b769-51b72d03521d",
                        "description": "Open a .docx file that loads a remote .dotm macro enabled template from https://github.com/redcanaryco/atomic-red-team/tree/master/atomics/T1221/src/opencalc.dotm \nExecutes the code specified within the .dotm template.\nRequires download of WINWORD found in Microsoft Ofiice at Microsoft: https://www.microsoft.com/en-us/download/office.aspx.  \nDefault docs file opens Calculator.exe when test sucessfully executed, while AV turned off.\n",
                        "supported_platforms": [
                            "windows"
                        ],
                        "input_arguments": {
                            "docx_file": {
                                "description": "Location of the test docx file on the local filesystem.",
                                "type": "path",
                                "default": "PathToAtomicsFolder\\T1221\\src\\Calculator.docx"
                            }
                        },
                        "executor": {
                            "command": "start \"#{docx_file}\"\n",
                            "name": "command_prompt"
                        }
                    }
                ]
            }
        ]
    },
    "timestamp": "2025-02-28 14:25:23"
}