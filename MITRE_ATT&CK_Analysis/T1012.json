{
    "id": "T1012",
    "name": "Query Registry",
    "description": "Adversaries may interact with the Windows Registry to gather information about the system, configuration, and installed software.\nThe Registry contains a significant amount of information about the operating system, configuration, software, and security.(Citation: Wikipedia Windows Registry) Information can easily be queried using the [Reg](S0075) utility, though other means to access the Registry exist. Some of the information may help adversaries to further their operation within a network. Adversaries may use the information from [Query Registry](T1012) during automated discovery to shape follow-on behaviors, including whether or not the adversary fully infects the target and/or attempts specific actions.",
    "platforms": "Windows",
    "kill_chain_phases": "Discovery",
    "data_sources": "Process: Process Creation, Command: Command Execution, Windows Registry: Windows Registry Key Access, Process: OS API Execution",
    "detection": "System and network discovery techniques normally occur throughout an operation as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Lateral Movement, based on the information obtained.\nInteraction with the Windows Registry may come from the command line using utilities such as [Reg](S0075) or through running malware that may interact with the Registry through an API. Command-line invocation of utilities used to query the Registry may be detected through process and command-line monitoring. Remote access tools with built-in features may interact directly with the Windows API to gather information. Information may also be acquired through Windows system management tools such as [Windows Management Instrumentation](T1047) and [PowerShell](T1059.001).",
    "url": "https://attack.mitre.org/techniques/T1012",
    "enrichments": {
        "attack_rule_map": [],
        "cycat": {
            "cycat": {
                "cycat_related_uuids": [
                    "68fcba0d-73a5-475e-a915-e8b4c576827e",
                    "5d6e7aa3-aca4-46cc-b96a-46ac950d210f",
                    "5d64d069-0fa0-45a4-bd65-b6f0950d210f",
                    "5eeec9aa-9d88-4ece-9e6f-9d92884ae404",
                    "c32f7008-9fea-41f7-8366-5eb9b74bd896",
                    "2b30fa36-3a18-402f-a22d-bf4ce2189f35",
                    "f0e53e89-8d22-46ea-9db5-9d4796ee2f8a",
                    "1cfac73c-be78-4f9a-9b08-5bde0c3953ab",
                    "82880171-b475-4201-b811-e9c826cd5eaa",
                    "1d2ab8ac-1a01-423b-9c39-001510eae8e8",
                    "f8748f2c-89dc-4d95-afb0-5a2dfdbad332",
                    "970007b7-ce32-49d0-a4a4-fbef016950bd",
                    "ff151c33-45fa-475d-af4f-c2f93571f4fe",
                    "0640214c-95af-4c04-a574-2a1ba6dda00b",
                    "9a4ff3b8-6187-4fd2-8e8b-e0eae1129495",
                    "25adc94b-5b29-44fe-a4a8-c89d17ff3566",
                    "5ce6aa86-9cd8-4302-9dc9-4a59950d210f",
                    "f35d4a9f-881b-46b7-9d8a-887a40bce133",
                    "54dd4ef7-f7b2-418e-a191-5def4fbb0033",
                    "74ad4314-482e-4c3e-b237-3f7ed3b9ca8d",
                    "5ced8da1-0960-40bc-b5dc-2fed0a016219",
                    "5e55be1a-3a30-48ae-9934-4199950d210f",
                    "5df8df26-fe0e-4858-94a7-6cf71d9519c9"
                ],
                "lookup_results": [
                    {
                        "uuid": "68fcba0d-73a5-475e-a915-e8b4c576827e",
                        "lookup_data": {
                            "description": "Remote registry management using REG utility from non-admin workstation",
                            "raw": "author: Teymur Kheirkhabarov, oscd.community\ndate: 2019/10/22\ndescription: Remote registry management using REG utility from non-admin workstation\ndetection:\n  condition: selection_1 and not selection_2\n  selection_1:\n    EventID: 5145\n    RelativeTargetName|contains: \\winreg\n  selection_2:\n    IpAddress: '%Admins_Workstations%'\nfalsepositives:\n- Legitimate usage of remote registry management by administrator\nid: 68fcba0d-73a5-475e-a915-e8b4c576827e\nlevel: medium\nlogsource:\n  product: windows\n  service: security\nmodified: 2020/08/23\nreferences:\n- https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment\nstatus: experimental\ntags:\n- attack.defense_evasion\n- attack.t1112\n- attack.discovery\n- attack.t1012\n- attack.credential_access\n- attack.t1552.002\n- attack.s0075\ntitle: Remote Registry Management Using Reg Utility\n",
                            "sigma:id": "68fcba0d-73a5-475e-a915-e8b4c576827e",
                            "title": "Remote Registry Management Using Reg Utility",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "5d6e7aa3-aca4-46cc-b96a-46ac950d210f",
                        "lookup_data": {
                            "description": "SectorJ04 Groupâ€™s Increased Activity in 2019",
                            "link": "https://www.circl.lu/doc/misp/feed-osint/5d6e7aa3-aca4-46cc-b96a-46ac950d210f.json",
                            "misp:feed": "https://www.circl.lu/doc/misp/feed-osint",
                            "timestamp": "1568039252",
                            "uuid": "5d6e7aa3-aca4-46cc-b96a-46ac950d210f",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "5d64d069-0fa0-45a4-bd65-b6f0950d210f",
                        "lookup_data": {
                            "description": "OSINT - Gamaredon group",
                            "link": "https://www.circl.lu/doc/misp/feed-osint/5d64d069-0fa0-45a4-bd65-b6f0950d210f.json",
                            "misp:feed": "https://www.circl.lu/doc/misp/feed-osint",
                            "timestamp": "1566995352",
                            "uuid": "5d64d069-0fa0-45a4-bd65-b6f0950d210f",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "5eeec9aa-9d88-4ece-9e6f-9d92884ae404",
                        "lookup_data": {
                            "description": "Dissecting PlugX to Extract Its Crown Jewels",
                            "link": "https://www.circl.lu/doc/misp/feed-osint/5eeec9aa-9d88-4ece-9e6f-9d92884ae404.json",
                            "misp:feed": "https://www.circl.lu/doc/misp/feed-osint",
                            "timestamp": "1663580963",
                            "uuid": "5eeec9aa-9d88-4ece-9e6f-9d92884ae404",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "c32f7008-9fea-41f7-8366-5eb9b74bd896",
                        "lookup_data": {
                            "capec": "CAPEC-647",
                            "mitre-attack-id": "T1012",
                            "mitre-cti:description": "Adversaries may interact with the Windows Registry to gather information about the system, configuration, and installed software.\n\nThe Registry contains a significant amount of information about the operating system, configuration, software, and security.(Citation: Wikipedia Windows Registry) Information can easily be queried using the [Reg](https://attack.mitre.org/software/S0075) utility, though other means to access the Registry exist. Some of the information may help adversaries to further their operation within a network. Adversaries may use the information from [Query Registry](https://attack.mitre.org/techniques/T1012) during automated discovery to shape follow-on behaviors, including whether or not the adversary fully infects the target and/or attempts specific actions.",
                            "mitre-cti:name": "Query Registry",
                            "mitre-cti:type": "attack-pattern",
                            "raw": "{'x_mitre_platforms': ['Windows'], 'x_mitre_domains': ['enterprise-attack'], 'object_marking_refs': ['marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168'], 'id': 'attack-pattern--c32f7008-9fea-41f7-8366-5eb9b74bd896', 'type': 'attack-pattern', 'created': '2017-05-31T21:30:25.584Z', 'created_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5', 'external_references': [{'source_name': 'mitre-attack', 'external_id': 'T1012', 'url': 'https://attack.mitre.org/techniques/T1012'}, {'external_id': 'CAPEC-647', 'source_name': 'capec', 'url': 'https://capec.mitre.org/data/definitions/647.html'}, {'url': 'https://en.wikipedia.org/wiki/Windows_Registry', 'description': 'Wikipedia. (n.d.). Windows Registry. Retrieved February 2, 2015.', 'source_name': 'Wikipedia Windows Registry'}], 'modified': '2020-03-26T18:08:20.049Z', 'name': 'Query Registry', 'description': 'Adversaries may interact with the Windows Registry to gather information about the system, configuration, and installed software.\\n\\nThe Registry contains a significant amount of information about the operating system, configuration, software, and security.(Citation: Wikipedia Windows Registry) Information can easily be queried using the [Reg](https://attack.mitre.org/software/S0075) utility, though other means to access the Registry exist. Some of the information may help adversaries to further their operation within a network. Adversaries may use the information from [Query Registry](https://attack.mitre.org/techniques/T1012) during automated discovery to shape follow-on behaviors, including whether or not the adversary fully infects the target and/or attempts specific actions.', 'kill_chain_phases': [{'kill_chain_name': 'mitre-attack', 'phase_name': 'discovery'}], 'x_mitre_detection': 'System and network discovery techniques normally occur throughout an operation as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Lateral Movement, based on the information obtained.\\n\\nInteraction with the Windows Registry may come from the command line using utilities such as [Reg](https://attack.mitre.org/software/S0075) or through running malware that may interact with the Registry through an API. Command-line invocation of utilities used to query the Registry may be detected through process and command-line monitoring. Remote access tools with built-in features may interact directly with the Windows API to gather information. Information may also be acquired through Windows system management tools such as [Windows Management Instrumentation](https://attack.mitre.org/techniques/T1047) and [PowerShell](https://attack.mitre.org/techniques/T1059/001).', 'x_mitre_version': '1.2', 'x_mitre_modified_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5', 'x_mitre_data_sources': ['Process: OS API Execution', 'Process: Process Creation', 'Command: Command Execution', 'Windows Registry: Windows Registry Key Access'], 'x_mitre_permissions_required': ['User', 'Administrator', 'SYSTEM'], 'x_mitre_is_subtechnique': False}",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "2b30fa36-3a18-402f-a22d-bf4ce2189f35",
                        "lookup_data": {
                            "description": "Detects activity that could be related to Baby Shark malware",
                            "raw": "author: Florian Roth (Nextron Systems)\ndate: 2019/02/24\ndescription: Detects activity that could be related to Baby Shark malware\ndetection:\n  condition: selection\n  selection:\n    CommandLine|contains:\n    - reg query \"HKEY_CURRENT_USER\\Software\\Microsoft\\Terminal Server Client\\Default\"\n    - powershell.exe mshta.exe http\n    - cmd.exe /c taskkill /im cmd.exe\nfalsepositives:\n- Unknown\nid: 2b30fa36-3a18-402f-a22d-bf4ce2189f35\nlevel: high\nlogsource:\n  category: process_creation\n  product: windows\nmodified: 2022/11/11\nreferences:\n- https://unit42.paloaltonetworks.com/new-babyshark-malware-targets-u-s-national-security-think-tanks/\nstatus: test\ntags:\n- attack.execution\n- attack.t1059.003\n- attack.t1059.001\n- attack.discovery\n- attack.t1012\n- attack.defense_evasion\n- attack.t1218.005\ntitle: Baby Shark Activity\n",
                            "sigma:id": "2b30fa36-3a18-402f-a22d-bf4ce2189f35",
                            "title": "Baby Shark Activity",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "f0e53e89-8d22-46ea-9db5-9d4796ee2f8a",
                        "lookup_data": {
                            "description": "Detects the export of the target Registry key to a file.",
                            "raw": "author: Oddvar Moe, Sander Wiebing, oscd.community\ndate: 2020/10/07\ndescription: Detects the export of the target Registry key to a file.\ndetection:\n  condition: selection and not all of filter_*\n  filter_1:\n    CommandLine|contains:\n    - hklm\n    - hkey_local_machine\n  filter_2:\n    CommandLine|endswith:\n    - \\system\n    - \\sam\n    - \\security\n  selection:\n    CommandLine|contains:\n    - ' /E '\n    - ' -E '\n    Image|endswith: \\regedit.exe\nfalsepositives:\n- Legitimate export of keys\nfields:\n- ParentImage\n- CommandLine\nid: f0e53e89-8d22-46ea-9db5-9d4796ee2f8a\nlevel: low\nlogsource:\n  category: process_creation\n  product: windows\nmodified: 2022/07/07\nreferences:\n- https://lolbas-project.github.io/lolbas/Binaries/Regedit/\n- https://gist.github.com/api0cradle/cdd2d0d0ec9abb686f0e89306e277b8f\nrelated:\n- id: 82880171-b475-4201-b811-e9c826cd5eaa\n  type: similar\nstatus: test\ntags:\n- attack.exfiltration\n- attack.t1012\ntitle: Exports Registry Key To a File\n",
                            "sigma:id": "f0e53e89-8d22-46ea-9db5-9d4796ee2f8a",
                            "title": "Exports Registry Key To a File",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "1cfac73c-be78-4f9a-9b08-5bde0c3953ab",
                        "lookup_data": {
                            "description": "Detects activity mentioned in Operation Wocao report",
                            "raw": "author: Florian Roth (Nextron Systems), frack113\ndate: 2019/12/20\ndescription: Detects activity mentioned in Operation Wocao report\ndetection:\n  condition: selection\n  selection:\n    CommandLine|contains:\n    - checkadmin.exe 127.0.0.1 -all\n    - netsh advfirewall firewall add rule name=powershell dir=in\n    - cmd /c powershell.exe -ep bypass -file c:\\s.ps1\n    - /tn win32times /f\n    - create win32times binPath=\n    - \\c$\\windows\\system32\\devmgr.dll\n    - ' -exec bypass -enc JgAg'\n    - type *keepass\\KeePass.config.xml\n    - iie.exe iie.txt\n    - reg query HKEY_CURRENT_USER\\Software\\\\*\\PuTTY\\Sessions\\\nfalsepositives:\n- Administrators that use checkadmin.exe tool to enumerate local administrators\nid: 1cfac73c-be78-4f9a-9b08-5bde0c3953ab\nlevel: high\nlogsource:\n  category: process_creation\n  definition: The 'System Security Extension' audit subcategory need to be enabled\n    to log the EID 4697\n  product: windows\nmodified: 2022/10/09\nreferences:\n- https://www.fox-it.com/en/news/whitepapers/operation-wocao-shining-a-light-on-one-of-chinas-hidden-hacking-groups/\n- https://twitter.com/SBousseaden/status/1207671369963646976\nrelated:\n- id: 74ad4314-482e-4c3e-b237-3f7ed3b9ca8d\n  type: derived\nstatus: test\ntags:\n- attack.discovery\n- attack.t1012\n- attack.defense_evasion\n- attack.t1036.004\n- attack.t1027\n- attack.execution\n- attack.t1053.005\n- attack.t1059.001\ntitle: Operation Wocao Activity\n",
                            "sigma:id": "1cfac73c-be78-4f9a-9b08-5bde0c3953ab",
                            "title": "Operation Wocao Activity",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "82880171-b475-4201-b811-e9c826cd5eaa",
                        "lookup_data": {
                            "description": "Detects the export of a crital Registry key to a file.",
                            "raw": "author: Oddvar Moe, Sander Wiebing, oscd.community\ndate: 2020/10/12\ndescription: Detects the export of a crital Registry key to a file.\ndetection:\n  condition: all of selection*\n  selection:\n    CommandLine|contains:\n    - ' /E '\n    - ' -E '\n    Image|endswith: \\regedit.exe\n  selection_2:\n    CommandLine|contains:\n    - hklm\n    - hkey_local_machine\n  selection_3:\n    CommandLine|endswith:\n    - \\system\n    - \\sam\n    - \\security\nfalsepositives:\n- Dumping hives for legitimate purpouse i.e. backup or forensic investigation\nfields:\n- ParentImage\n- CommandLine\nid: 82880171-b475-4201-b811-e9c826cd5eaa\nlevel: high\nlogsource:\n  category: process_creation\n  product: windows\nmodified: 2022/07/07\nreferences:\n- https://lolbas-project.github.io/lolbas/Binaries/Regedit/\n- https://gist.github.com/api0cradle/cdd2d0d0ec9abb686f0e89306e277b8f\nrelated:\n- id: f0e53e89-8d22-46ea-9db5-9d4796ee2f8a\n  type: similar\nstatus: test\ntags:\n- attack.exfiltration\n- attack.t1012\ntitle: Exports Critical Registry Keys To a File\n",
                            "sigma:id": "82880171-b475-4201-b811-e9c826cd5eaa",
                            "title": "Exports Critical Registry Keys To a File",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "1d2ab8ac-1a01-423b-9c39-001510eae8e8",
                        "lookup_data": {
                            "description": "This detection uses Windows security events to detect suspicious access attempts to the registry key values and sub-keys of Azure AD Health service agents (e.g AD FS).\nInformation from AD Health service agents can be used to potentially abuse some of the features provided by those services in the cloud (e.g. Federation).\nThis detection requires an access control entry (ACE) on the system access control list (SACL) of the following securable object: HKLM:\\SOFTWARE\\Microsoft\\ADHealthAgent.\nMake sure you set the SACL to propagate to its sub-keys.\n",
                            "raw": "author: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research), MSTIC\ndate: 2021/08/26\ndescription: 'This detection uses Windows security events to detect suspicious access\n  attempts to the registry key values and sub-keys of Azure AD Health service agents\n  (e.g AD FS).\n\n  Information from AD Health service agents can be used to potentially abuse some\n  of the features provided by those services in the cloud (e.g. Federation).\n\n  This detection requires an access control entry (ACE) on the system access control\n  list (SACL) of the following securable object: HKLM:\\SOFTWARE\\Microsoft\\ADHealthAgent.\n\n  Make sure you set the SACL to propagate to its sub-keys.\n\n  '\ndetection:\n  condition: selection and not filter\n  filter:\n    ProcessName|contains:\n    - Microsoft.Identity.Health.Adfs.DiagnosticsAgent.exe\n    - Microsoft.Identity.Health.Adfs.InsightsService.exe\n    - Microsoft.Identity.Health.Adfs.MonitoringAgent.Startup.exe\n    - Microsoft.Identity.Health.Adfs.PshSurrogate.exe\n    - Microsoft.Identity.Health.Common.Clients.ResourceMonitor.exe\n  selection:\n    EventID:\n    - 4656\n    - 4663\n    ObjectName: \\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\ADHealthAgent\n    ObjectType: Key\nfalsepositives:\n- Unknown\nid: 1d2ab8ac-1a01-423b-9c39-001510eae8e8\nlevel: medium\nlogsource:\n  product: windows\n  service: security\nmodified: 2022/10/09\nreferences:\n- https://o365blog.com/post/hybridhealthagent/\n- https://github.com/OTRF/Set-AuditRule/blob/c3dec5443414231714d850565d364ca73475ade5/rules/registry/aad_connect_health_service_agent.yml\nstatus: test\ntags:\n- attack.discovery\n- attack.t1012\ntitle: Azure AD Health Service Agents Registry Keys Access\n",
                            "sigma:id": "1d2ab8ac-1a01-423b-9c39-001510eae8e8",
                            "title": "Azure AD Health Service Agents Registry Keys Access",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "f8748f2c-89dc-4d95-afb0-5a2dfdbad332",
                        "lookup_data": {
                            "description": "Detects handles requested to SAM registry hive",
                            "raw": "author: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019/08/12\ndescription: Detects handles requested to SAM registry hive\ndetection:\n  condition: selection\n  selection:\n    EventID: 4656\n    ObjectName|endswith: \\SAM\n    ObjectType: Key\nfalsepositives:\n- Unknown\nfields:\n- ComputerName\n- SubjectDomainName\n- SubjectUserName\n- ProcessName\n- ObjectName\nid: f8748f2c-89dc-4d95-afb0-5a2dfdbad332\nlevel: high\nlogsource:\n  product: windows\n  service: security\nmodified: 2021/11/27\nreferences:\n- https://threathunterplaybook.com/notebooks/windows/07_discovery/WIN-190725024610.html\nstatus: test\ntags:\n- attack.discovery\n- attack.t1012\n- attack.credential_access\n- attack.t1552.002\ntitle: SAM Registry Hive Handle Request\n",
                            "sigma:id": "f8748f2c-89dc-4d95-afb0-5a2dfdbad332",
                            "title": "SAM Registry Hive Handle Request",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "970007b7-ce32-49d0-a4a4-fbef016950bd",
                        "lookup_data": {
                            "description": "Adversaries may interact with the Windows Registry to gather information about credentials, the system, configuration, and installed software.",
                            "raw": "author: Timur Zinniatullin, oscd.community\ndate: 2019/10/21\ndescription: Adversaries may interact with the Windows Registry to gather information\n  about credentials, the system, configuration, and installed software.\ndetection:\n  condition: all of selection_*\n  selection_1:\n    CommandLine|contains:\n    - query\n    - save\n    - export\n    Image|endswith: \\reg.exe\n  selection_2:\n    CommandLine|contains:\n    - currentVersion\\windows\n    - winlogon\\\n    - currentVersion\\shellServiceObjectDelayLoad\n    - currentVersion\\run\n    - currentVersion\\policies\\explorer\\run\n    - currentcontrolset\\services\nfields:\n- Image\n- CommandLine\n- User\n- LogonGuid\n- Hashes\n- ParentProcessGuid\n- ParentCommandLine\nid: 970007b7-ce32-49d0-a4a4-fbef016950bd\nlevel: low\nlogsource:\n  category: process_creation\n  product: windows\nreferences:\n- https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1012/T1012.md\nstatus: test\ntags:\n- attack.discovery\n- attack.t1012\n- attack.t1007\ntitle: Query Registry\n",
                            "sigma:id": "970007b7-ce32-49d0-a4a4-fbef016950bd",
                            "title": "Query Registry",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "ff151c33-45fa-475d-af4f-c2f93571f4fe",
                        "lookup_data": {
                            "description": "This detection uses Windows security events to detect suspicious access attempts to the registry key of Azure AD Health monitoring agent.\nThis detection requires an access control entry (ACE) on the system access control list (SACL) of the following securable object HKLM\\SOFTWARE\\Microsoft\\Microsoft Online\\Reporting\\MonitoringAgent.\n",
                            "raw": "author: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research), MSTIC\ndate: 2021/08/26\ndescription: 'This detection uses Windows security events to detect suspicious access\n  attempts to the registry key of Azure AD Health monitoring agent.\n\n  This detection requires an access control entry (ACE) on the system access control\n  list (SACL) of the following securable object HKLM\\SOFTWARE\\Microsoft\\Microsoft\n  Online\\Reporting\\MonitoringAgent.\n\n  '\ndetection:\n  condition: selection and not filter\n  filter:\n    ProcessName|contains:\n    - Microsoft.Identity.Health.Adfs.DiagnosticsAgent.exe\n    - Microsoft.Identity.Health.Adfs.InsightsService.exe\n    - Microsoft.Identity.Health.Adfs.MonitoringAgent.Startup.exe\n    - Microsoft.Identity.Health.Adfs.PshSurrogate.exe\n    - Microsoft.Identity.Health.Common.Clients.ResourceMonitor.exe\n  selection:\n    EventID:\n    - 4656\n    - 4663\n    ObjectName: \\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Microsoft Online\\Reporting\\MonitoringAgent\n    ObjectType: Key\nfalsepositives:\n- Unknown\nid: ff151c33-45fa-475d-af4f-c2f93571f4fe\nlevel: medium\nlogsource:\n  product: windows\n  service: security\nmodified: 2022/10/09\nreferences:\n- https://o365blog.com/post/hybridhealthagent/\n- https://github.com/OTRF/Set-AuditRule/blob/c3dec5443414231714d850565d364ca73475ade5/rules/registry/aad_connect_health_monitoring_agent.yml\nstatus: test\ntags:\n- attack.discovery\n- attack.t1012\ntitle: Azure AD Health Monitoring Agent Registry Keys Access\n",
                            "sigma:id": "ff151c33-45fa-475d-af4f-c2f93571f4fe",
                            "title": "Azure AD Health Monitoring Agent Registry Keys Access",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "0640214c-95af-4c04-a574-2a1ba6dda00b",
                        "lookup_data": {
                            "mitre-attack-id": "T1012",
                            "mitre-cti:description": "Identify unnecessary system utilities or potentially malicious software that may be used to acquire information within the Registry, and audit and/or block them by using whitelisting (Citation: Beechey 2010) tools, like AppLocker, (Citation: Windows Commands JPCERT) (Citation: NSA MS AppLocker) or Software Restriction Policies (Citation: Corio 2008) where appropriate. (Citation: TechNet Applocker vs SRP)",
                            "mitre-cti:name": "Query Registry Mitigation",
                            "mitre-cti:type": "course-of-action",
                            "raw": "{'x_mitre_domains': ['enterprise-attack'], 'object_marking_refs': ['marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168'], 'id': 'course-of-action--0640214c-95af-4c04-a574-2a1ba6dda00b', 'type': 'course-of-action', 'created': '2018-10-17T00:14:20.652Z', 'created_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5', 'external_references': [{'external_id': 'T1012', 'url': 'https://attack.mitre.org/mitigations/T1012', 'source_name': 'mitre-attack'}, {'source_name': 'Beechey 2010', 'description': 'Beechey, J. (2010, December). Application Whitelisting: Panacea or Propaganda?. Retrieved November 18, 2014.', 'url': 'http://www.sans.org/reading-room/whitepapers/application/application-whitelisting-panacea-propaganda-33599'}, {'url': 'http://blog.jpcert.or.jp/2016/01/windows-commands-abused-by-attackers.html', 'description': 'Tomonaga, S. (2016, January 26). Windows Commands Abused by Attackers. Retrieved February 2, 2016.', 'source_name': 'Windows Commands JPCERT'}, {'url': 'https://apps.nsa.gov/iaarchive/library/ia-guidance/tech-briefs/application-whitelisting-using-microsoft-applocker.cfm', 'description': 'NSA Information Assurance Directorate. (2014, August). Application Whitelisting Using Microsoft AppLocker. Retrieved March 31, 2016.', 'source_name': 'NSA MS AppLocker'}, {'source_name': 'Corio 2008', 'description': 'Corio, C., & Sayana, D. P. (2008, June). Application Lockdown with Software Restriction Policies. Retrieved November 18, 2014.', 'url': 'http://technet.microsoft.com/en-us/magazine/2008.06.srp.aspx'}, {'source_name': 'TechNet Applocker vs SRP', 'description': 'Microsoft. (2012, June 27). Using Software Restriction Policies and AppLocker Policies. Retrieved April 7, 2016.', 'url': 'https://technet.microsoft.com/en-us/library/ee791851.aspx'}], 'modified': '2020-01-17T16:45:24.641Z', 'name': 'Query Registry Mitigation', 'description': 'Identify unnecessary system utilities or potentially malicious software that may be used to acquire information within the Registry, and audit and/or block them by using whitelisting (Citation: Beechey 2010) tools, like AppLocker, (Citation: Windows Commands JPCERT) (Citation: NSA MS AppLocker) or Software Restriction Policies (Citation: Corio 2008) where appropriate. (Citation: TechNet Applocker vs SRP)', 'x_mitre_deprecated': True, 'x_mitre_version': '1.0', 'x_mitre_modified_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5'}",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "9a4ff3b8-6187-4fd2-8e8b-e0eae1129495",
                        "lookup_data": {
                            "description": "Detects handle requests and access operations to specific registry keys to calculate the SysKey",
                            "raw": "author: Roberto Rodriguez @Cyb3rWard0g\ndate: 2019/08/12\ndescription: Detects handle requests and access operations to specific registry keys\n  to calculate the SysKey\ndetection:\n  condition: selection\n  selection:\n    EventID:\n    - 4656\n    - 4663\n    ObjectName|endswith:\n    - lsa\\JD\n    - lsa\\GBG\n    - lsa\\Skew1\n    - lsa\\Data\n    ObjectType: key\nfalsepositives:\n- Unknown\nid: 9a4ff3b8-6187-4fd2-8e8b-e0eae1129495\nlevel: high\nlogsource:\n  product: windows\n  service: security\nmodified: 2021/11/27\nreferences:\n- https://threathunterplaybook.com/notebooks/windows/07_discovery/WIN-190625024610.html\nstatus: test\ntags:\n- attack.discovery\n- attack.t1012\ntitle: SysKey Registry Keys Access\n",
                            "sigma:id": "9a4ff3b8-6187-4fd2-8e8b-e0eae1129495",
                            "title": "SysKey Registry Keys Access",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "25adc94b-5b29-44fe-a4a8-c89d17ff3566",
                        "lookup_data": {
                            "description": "UNC3524: Eye Spy on Your Email",
                            "link": "http://www.botvrij.eu/data/feed-osint/25adc94b-5b29-44fe-a4a8-c89d17ff3566.json",
                            "misp:feed": "http://www.botvrij.eu/data/feed-osint",
                            "timestamp": "1652459344",
                            "uuid": "25adc94b-5b29-44fe-a4a8-c89d17ff3566",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "5ce6aa86-9cd8-4302-9dc9-4a59950d210f",
                        "lookup_data": {
                            "description": "OSINT - A journey to Zebrocy land",
                            "link": "https://www.circl.lu/doc/misp/feed-osint/5ce6aa86-9cd8-4302-9dc9-4a59950d210f.json",
                            "misp:feed": "https://www.circl.lu/doc/misp/feed-osint",
                            "timestamp": "1563528054",
                            "uuid": "5ce6aa86-9cd8-4302-9dc9-4a59950d210f",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "f35d4a9f-881b-46b7-9d8a-887a40bce133",
                        "lookup_data": {
                            "description": "The SideWalk may be as dangerous as the CROSSWALK",
                            "link": "http://www.botvrij.eu/data/feed-osint/f35d4a9f-881b-46b7-9d8a-887a40bce133.json",
                            "misp:feed": "http://www.botvrij.eu/data/feed-osint",
                            "timestamp": "1630180802",
                            "uuid": "f35d4a9f-881b-46b7-9d8a-887a40bce133",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "54dd4ef7-f7b2-418e-a191-5def4fbb0033",
                        "lookup_data": {
                            "description": "Turla: A Galaxy of Opportunity",
                            "link": "http://www.botvrij.eu/data/feed-osint/54dd4ef7-f7b2-418e-a191-5def4fbb0033.json",
                            "misp:feed": "http://www.botvrij.eu/data/feed-osint",
                            "timestamp": "1673286950",
                            "uuid": "54dd4ef7-f7b2-418e-a191-5def4fbb0033",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "74ad4314-482e-4c3e-b237-3f7ed3b9ca8d",
                        "lookup_data": {
                            "description": "Detects activity mentioned in Operation Wocao report",
                            "raw": "author: Florian Roth (Nextron Systems), frack113\ndate: 2019/12/20\ndescription: Detects activity mentioned in Operation Wocao report\ndetection:\n  condition: selection\n  selection:\n    CallerProcessName|endswith: \\checkadmin.exe\n    EventID: 4799\n    TargetUserName|startswith: Administr\nfalsepositives:\n- Administrators that use checkadmin.exe tool to enumerate local administrators\nid: 74ad4314-482e-4c3e-b237-3f7ed3b9ca8d\nlevel: high\nlogsource:\n  product: windows\n  service: security\nmodified: 2022/11/27\nreferences:\n- https://www.fox-it.com/en/news/whitepapers/operation-wocao-shining-a-light-on-one-of-chinas-hidden-hacking-groups/\n- https://twitter.com/SBousseaden/status/1207671369963646976\nstatus: test\ntags:\n- attack.discovery\n- attack.t1012\n- attack.defense_evasion\n- attack.t1036.004\n- attack.t1027\n- attack.execution\n- attack.t1053.005\n- attack.t1059.001\ntitle: Operation Wocao Activity - Security\n",
                            "sigma:id": "74ad4314-482e-4c3e-b237-3f7ed3b9ca8d",
                            "title": "Operation Wocao Activity - Security",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "5ced8da1-0960-40bc-b5dc-2fed0a016219",
                        "lookup_data": {
                            "description": "Turla PowerShell blogpost",
                            "link": "http://www.botvrij.eu/data/feed-osint/5ced8da1-0960-40bc-b5dc-2fed0a016219.json",
                            "misp:feed": "http://www.botvrij.eu/data/feed-osint",
                            "timestamp": "1559232101",
                            "uuid": "5ced8da1-0960-40bc-b5dc-2fed0a016219",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "5e55be1a-3a30-48ae-9934-4199950d210f",
                        "lookup_data": {
                            "description": "Interesting Recon Script",
                            "link": "https://www.circl.lu/doc/misp/feed-osint/5e55be1a-3a30-48ae-9934-4199950d210f.json",
                            "misp:feed": "https://www.circl.lu/doc/misp/feed-osint",
                            "timestamp": "1582912038",
                            "uuid": "5e55be1a-3a30-48ae-9934-4199950d210f",
                            "_cycat_type": "Item"
                        }
                    },
                    {
                        "uuid": "5df8df26-fe0e-4858-94a7-6cf71d9519c9",
                        "lookup_data": {
                            "description": "UEFI threats moving to the ESP: Introducing ESPecter bootkit",
                            "link": "https://www.circl.lu/doc/misp/feed-osint/5df8df26-fe0e-4858-94a7-6cf71d9519c9.json",
                            "misp:feed": "https://www.circl.lu/doc/misp/feed-osint",
                            "timestamp": "1637336858",
                            "uuid": "5df8df26-fe0e-4858-94a7-6cf71d9519c9",
                            "_cycat_type": "Item"
                        }
                    }
                ]
            }
        },
        "atomics": [
            {
                "attack_technique": "T1012",
                "display_name": "Query Registry",
                "atomic_tests": [
                    {
                        "name": "Query Registry",
                        "auto_generated_guid": "8f7578c4-9863-4d83-875c-a565573bbdf0",
                        "description": "Query Windows Registry.\nUpon successful execution, cmd.exe will perform multiple reg queries. Some will succeed and others will fail (dependent upon OS).\nReferences:\nhttps://blog.cylance.com/windows-registry-persistence-part-2-the-run-keys-and-search-order\nhttps://blog.cylance.com/windows-registry-persistence-part-1-introduction-attack-phases-and-windows-services\nhttp://www.handgrep.se/repository/cheatsheets/postexploitation/WindowsPost-Exploitation.pdf\nhttps://www.offensive-security.com/wp-content/uploads/2015/04/wp.Registry_Quick_Find_Chart.en_us.pdf\n",
                        "supported_platforms": [
                            "windows"
                        ],
                        "executor": {
                            "command": "reg query \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\"\nreg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunServicesOnce\nreg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunServicesOnce\nreg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunServices\nreg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunServices\nreg query \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Notify\"\nreg query \"HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Userinit\"\nreg query \"HKCU\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\\\Shell\"\nreg query \"HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\\\Shell\"\nreg query HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\ShellServiceObjectDelayLoad\nreg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\nreg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\nreg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\nreg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\nreg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\nreg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\nreg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\nreg query HKLM\\system\\currentcontrolset\\services /s | findstr ImagePath 2>nul | findstr /Ri \".*\\.sys$\"\nreg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\nreg query HKLM\\SYSTEM\\CurrentControlSet\\Control\\SafeBoot\nreg query \"HKLM\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components\"\nreg query \"HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Group Policy\\Scripts\\Startup\"\n",
                            "name": "command_prompt",
                            "elevation_required": true
                        }
                    },
                    {
                        "name": "Query Registry with Powershell cmdlets",
                        "auto_generated_guid": "0434d081-bb32-42ce-bcbb-3548e4f2628f",
                        "description": "Query Windows Registry with Powershell cmdlets, i.e., Get-Item and Get-ChildItem. The results from above can also be achieved with Get-Item and Get-ChildItem.\nUnlike using \"reg query\" which then executes reg.exe, using cmdlets won't generate new processes, which may evade detection systems monitoring process generation. \n",
                        "supported_platforms": [
                            "windows"
                        ],
                        "executor": {
                            "command": "Get-Item -Path \"HKLM:SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\"\nGet-ChildItem -Path \"HKLM:SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\\" | findstr Windows\nGet-Item -Path \"HKLM:Software\\Microsoft\\Windows\\CurrentVersion\\RunServicesOnce\"\nGet-Item -Path \"HKCU:Software\\Microsoft\\Windows\\CurrentVersion\\RunServicesOnce\"\nGet-Item -Path \"HKLM:Software\\Microsoft\\Windows\\CurrentVersion\\RunServices\"\nGet-Item -Path \"HKCU:Software\\Microsoft\\Windows\\CurrentVersion\\RunServices\"\nGet-Item -Path \"HKLM:SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Notify\"\nGet-Item -Path \"HKLM:Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Userinit\"\nGet-Item -Path \"HKCU:Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\\\Shell\"\nGet-Item -Path \"HKLM:Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\\\Shell\"\nGet-Item -Path \"HKLM:SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\ShellServiceObjectDelayLoad\"\nGet-Item -Path \"HKLM:Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\"\nGet-Item -Path \"HKLM:Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\"\nGet-Item -Path \"HKLM:Software\\Microsoft\\Windows\\CurrentVersion\\Run\"\nGet-Item -Path \"HKCU:Software\\Microsoft\\Windows\\CurrentVersion\\Run\"\nGet-Item -Path \"HKCU:Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\"\nGet-Item -Path \"HKLM:Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\"\nGet-Item -Path \"HKCU:Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\"\nGet-ChildItem -Path \"HKLM:system\\currentcontrolset\\services\" \nGet-Item -Path \"HKLM:Software\\Microsoft\\Windows\\CurrentVersion\\Run\"\nGet-Item -Path \"HKLM:SYSTEM\\CurrentControlSet\\Control\\SafeBoot\"\nGet-ChildItem -Path \"HKLM:SOFTWARE\\Microsoft\\Active Setup\\Installed Components\"\nGet-ChildItem -Path \"HKLM:SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Group Policy\\Scripts\\Startup\"\n",
                            "name": "powershell",
                            "elevation_required": true
                        }
                    },
                    {
                        "name": "Enumerate COM Objects in Registry with Powershell",
                        "auto_generated_guid": "0d80d088-a84c-4353-af1a-fc8b439f1564",
                        "description": "This test is designed to enumerate the COM objects listed in HKCR, then output their methods and CLSIDs to a text file.\nAn adversary could then use this information to identify COM objects that might be vulnerable to abuse, such as using them to spawn arbitrary processes. \nSee: https://www.mandiant.com/resources/hunting-com-objects",
                        "supported_platforms": [
                            "windows"
                        ],
                        "input_arguments": {
                            "output_file": {
                                "description": "File to output list of COM objects to",
                                "type": "string",
                                "default": "$env:temp\\T1592.002Test1.txt"
                            }
                        },
                        "executor": {
                            "command": "New-PSDrive -PSProvider registry -Root HKEY_CLASSES_ROOT -Name HKCR\nGet-ChildItem -Path HKCR:\\CLSID -Name | Select -Skip 1 > $env:temp\\clsids.txt\nForEach($CLSID in Get-Content \"$env:temp\\clsids.txt\")\n{try{write-output \"$($Position)-$($CLSID)\"\nwrite-output \"------------\"| out-file #{output_file} -append\nwrite-output $($CLSID)| out-file #{output_file} -append\n$handle=[activator]::CreateInstance([type]::GetTypeFromCLSID($CLSID))\n$handle | get-member -erroraction silentlycontinue | out-file #{output_file} -append\n$position += 1} catch{}}\n",
                            "cleanup_command": "remove-item #{output_file} -force -erroraction silentlycontinue\nremove-item $env:temp\\clsids.txt -force -erroraction silentlycontinue      \n",
                            "name": "powershell"
                        }
                    },
                    {
                        "name": "Reg query for AlwaysInstallElevated status",
                        "auto_generated_guid": "6fb4c4c5-f949-4fd2-8af5-ddbc61595223",
                        "description": "The reg query commands allows to check the status of the AlwaysInstallElevated registry key for both the user and the machine. If both queries return a value of 0x1, then AlwaysInstallElevated is enabled for both user and machine thus allowing a regular user to install a Microsoft Windows Installer package with system level privileges. This can be abused by an attacker to escalate privileges in the host to SYSTEM level.",
                        "supported_platforms": [
                            "windows"
                        ],
                        "executor": {
                            "command": "reg query HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated\nreg query HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated      \n",
                            "name": "command_prompt",
                            "elevation_required": true
                        }
                    },
                    {
                        "name": "Check Software Inventory Logging (SIL) status via Registry",
                        "auto_generated_guid": "5c784969-1d43-4ac7-8c3d-ed6d025ed10d",
                        "description": "Microsoft's Software Inventory Logging (SIL) collects information about software installed per host basis. Adversary can use such logs to passively \ncheck for existence of software of interest to them. Status of SIL can be checked via registry.\n[Reference](https://blog.talosintelligence.com/chinese-hacking-group-apt41-compromised-taiwanese-government-affiliated-research-institute-with-shadowpad-and-cobaltstrike-2/)\n",
                        "supported_platforms": [
                            "windows"
                        ],
                        "executor": {
                            "command": "reg.exe query hklm\\software\\microsoft\\windows\\softwareinventorylogging /v collectionstate /reg:64\n",
                            "name": "command_prompt",
                            "elevation_required": true
                        }
                    },
                    {
                        "name": "Inspect SystemStartOptions Value in Registry",
                        "auto_generated_guid": "96257079-cdc1-4aba-8705-3146e94b6dce",
                        "description": "The objective of this test is to query the SystemStartOptions key under HKLM\\SYSTEM\\CurrentControlSet\\Control in the Windows registry. This action could be used to uncover specific details about how the system is configured to start, potentially aiding in understanding boot parameters or identifying security-related settings. key is.",
                        "supported_platforms": [
                            "windows"
                        ],
                        "executor": {
                            "name": "command_prompt",
                            "command": "reg.exe query HKLM\\SYSTEM\\CurrentControlSet\\Control /v SystemStartOptions\n"
                        }
                    }
                ]
            }
        ]
    },
    "timestamp": "2025-02-28 10:51:06"
}